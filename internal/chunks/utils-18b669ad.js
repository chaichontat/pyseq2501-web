var C=Object.defineProperty,E=Object.defineProperties;var O=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var y=(e,t,n)=>t in e?C(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,o=(e,t)=>{for(var n in t||(t={}))W.call(t,n)&&y(e,n,t[n]);if(b)for(var n of b(t))$.call(t,n)&&y(e,n,t[n]);return e},i=(e,t)=>E(e,O(t));import{D as h}from"./vendor-e337eed0.js";const _={pump:{reagent:"",volume:0,op:"pump"},prime:{reagent:"",volume:0,op:"prime"},temp:{temp:25,wait:!0,op:"temp"},hold:{time:0,op:"hold"},takeimage:{name:"Test",path:".",xy0:[0,0],xy1:[1,1],channels:[!0,!0,!0,!0],z_tilt:19850,z_obj:32e3,save:!1,lasers:[0,0],laser_onoff:[!0,!0],od:[0,0],overlap:.1,op:"takeimage",z_from:0,z_to:0,z_spacing:232},autofocus:{channels:[!0,!0,!0,!0],laser_onoff:!0,laser:5,od:0,op:"autofocus"},goto:{step:1,n:4,op:"goto"}},j={name:"",port:1,v_pull:100,v_prime:200,v_push:2e3,wait:26};function k(e){return{name:"",path:".",fc:!1,reagents:[{uid:e+1,reagent:o({},j)}],cmds:[{uid:e+2,cmd:o({},_.pump)}]}}function P(e,t){return{name:e.name,fc:e.fc,path:e.path,reagents:e.reagents.map(n=>({uid:++t,reagent:n})),cmds:e.cmds.map(n=>({uid:++t,cmd:n}))}}function q(e){return{name:e.name,fc:e.fc,path:e.path,reagents:e.reagents.map(t=>t.reagent),cmds:e.cmds.map(t=>t.cmd)}}const N={n:0,img:[""],hist:[{counts:[10],bin_edges:[0]}],channels:[!1,!1,!1,!1],dim:[0,0]},S={running:!1,step:0,msg:{msg:"",t:Date.now()}},z={x:-1,y:-1,z_tilt:[-1,-1,-1],z_obj:-1,od:[0,0],laser_onoff:[!0,!0],lasers:[-1,-1],shutter:!1,fcs:[o({},S),o({},S)],block:"",msg:{msg:"Error: not connected.",t:Date.now()},msg2:{msg:"",t:Date.now()}};function D(e,t,{f:n=JSON.parse,onOpen:u,localStore:l,sendOnSet:f=!0}={}){let a,c;const{set:p,subscribe:w,update:g}=h(t);function s(){console.log("Connecting"),c=null,a=new WebSocket(e),a.onmessage=r=>p(n(r.data)),a.onopen=async()=>{u&&await u(),l&&l.update(r=>i(o({},r),{connected:!0})),c&&(clearTimeout(c),c=null)},a.onclose=()=>{l&&l.update(r=>i(o({},r),{connected:!1})),c||(c=setTimeout(s,2e3)),console.error("Connection closed.")}}return s(),{set(r){f&&a&&a.readyState===WebSocket.OPEN&&(r instanceof Set?a.send(JSON.stringify(Array.from(r))):a.send(typeof r=="string"?r:JSON.stringify(r))),p(r)},update:g,subscribe:w}}function x(e,t,n,{f:u=JSON.parse,beforeOpen:l,localStore:f}={}){let a,c;const{set:p,subscribe:w}=h(t);async function g(){console.log("Connecting"),c=null,l&&await l(),a&&a.close(),a=new WebSocket(e),a.onmessage=s=>p(u(s.data)),a.onopen=()=>{f&&f.update(s=>i(o({},s),{connected:!0})),c&&(clearTimeout(c),c=null)},a.onclose=()=>{f&&f.update(s=>i(o({},s),{connected:!1})),c||(c=setTimeout(g,2e3)),console.error("Connection closed.")}}return g().catch(s=>console.error(s)),{set(s){a&&a.readyState===WebSocket.OPEN&&(console.log(),s instanceof Set?a.send(JSON.stringify(Array.from(s))):a.send(typeof s=="string"?s:JSON.stringify(s)))},update(){throw new Error("Cannot update an asymWritableWebSocket")},subscribe:w}}const v={block:"",max_uid:6,exps:[k(0),k(3)],image_params:i(o({},_.takeimage),{fc:!1})},d=h({mode:"automatic",connected:!1,img:o({},N),afimg:{afimg:Array(259).fill(""),laplacian:Array(259).fill(0)}}),U=D(`ws://${window.location.hostname}:8000/status`,o({},z),{localStore:d,onOpen:T,sendOnSet:!1}),m=h(o({},v)),J=D(`ws://${window.location.hostname}:8000/user`,o({},v),{onOpen:L}),A=x(`ws://${window.location.hostname}:8000/cmd`,{msg:"ok"});async function L(){for(;;)try{const t=await(await fetch(`http://${window.location.hostname}:8000/usersettings`)).json();m.set(t);return}catch{console.error("Cannot get initial user settings.")}}function F(){let e=Date.now(),t=setTimeout(()=>{},1e3);m.subscribe(n=>{const u=Date.now(),l=()=>{J.set(n),e=Date.now()};u-e<1e3?(clearTimeout(t),t=setTimeout(l,1e3-(u-e))):l()})}F();function R(e){e.msg==="imgReady"?(fetch(`http://${window.location.hostname}:8000/img`).then(t=>t.json()).then(t=>d.update(n=>i(o({},n),{img:t}))).catch(t=>alert(t)),m.update(t=>i(o({},t),{block:""}))):e.msg==="afimgReady"?(fetch(`http://${window.location.hostname}:8000/afimg`).then(t=>t.json()).then(t=>d.update(n=>i(o({},n),{afimg:t}))).catch(t=>alert(t)),m.update(t=>i(o({},t),{block:""}))):e.msg==="moveDone"&&m.update(t=>i(o({},t),{block:""}))}A.subscribe(R);async function T(){await fetch(`http://${window.location.hostname}:8000/img`).then(e=>e.json()).then(e=>d.update(t=>i(o({},t),{img:e}))).catch(()=>{}),await fetch(`http://${window.location.hostname}:8000/afimg`).then(e=>e.json()).then(e=>d.update(t=>i(o({},t),{afimg:e}))).catch(()=>{})}T().catch(()=>{});const V=fetch(`http://${window.location.hostname}:8000/config`).then(e=>e.json());function G(e){requestAnimationFrame(()=>{e&&(e.style.transition="none",e.style.backgroundColor="rgba(255,62,0,0.3)",setTimeout(()=>{e.style.transition="background 1s",e.style.backgroundColor=""}))})}function H(e){return e.reduce((t,n)=>i(o({},t),{[n]:(t[n]||0)+1}),{})}function K(e,t=[0,1/0]){const n=()=>{const u=parseFloat(e.value);t[0]<=u&&u<=t[1]?e.classList.remove("invalid"):e.classList.add("invalid")};return document.addEventListener("input",n),{destroy:()=>{document.removeEventListener("input",n)}}}export{K as a,V as b,A as c,H as d,_ as e,G as f,P as g,k as h,d as l,j as r,U as s,q as t,m as u};
